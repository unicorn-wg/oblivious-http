<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Oblivious HTTP</title>
<meta content="Martin Thomson" name="author">
<meta content="Christopher A. Wood" name="author">
<meta content="
       This document describes a system for the forwarding of encrypted HTTP messages.
This allows clients to make requests of servers without the server being able to
link requests to other requests from the same client. 
    " name="description">
<meta content="xml2rfc 3.5.0" name="generator">
<meta content="draft-thomson-http-oblivious" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.5.0
    Python 3.8.5
    appdirs 1.4.4
    ConfigArgParse 1.2.3
    google-i18n-address 2.4.0
    html5lib 1.1
    intervaltree 3.0.2
    Jinja2 2.11.2
    kitchen 1.2.6
    lxml 4.5.0
    pycountry 19.8.18
    pyflakes 2.1.1
    PyYAML 5.3.1
    requests 2.22.0
    setuptools 45.2.0
    six 1.14.0
-->
<link href="draft-thomson-http-oblivious.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@import url('https://martinthomson.github.io/i-d-template/fonts.css');

html {
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --small-font-size: 14.5px;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
#title {
  padding: 1em 0 0.2em;
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p, #abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 18px;
  line-height: 24px;
}
p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
dd.break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href].selfRef {
  color: var(--text-color);
}
a[href] {
  color: var(--link-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px 'Oxygen Mono', monospace;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  pre {
    display: inline-block;
    overflow-x: auto;
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  pre + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
tr:nth-child(2n) > td {
  background-color: var(--background-color);
}
tr:nth-child(2n+1) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n) > td {
  background-color: var(--highlight-color);
}
thead+tbody > tr:nth-child(2n+1) > td {
  background-color: var(--background-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: #ddd; }
a.pilcrow[href]:hover { text-decoration: none; }
@media screen {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: #bbb;
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 8em;
}
#identifiers dt {
  width: var(--identifier-width);
  margin: 0;
  clear: left;
  float: left;
  text-align: right;
}
#identifiers dd {
  margin: 0 0 0 calc(1em + var(--identifier-width));
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 500px) {
  .index ul {
    column-count: 2;
    column-gap: 20px;
  }
  .index ul ul {
    column-count: 1;
    column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul p, #toc ul li {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table .text-left, table .text-left {
  text-align: left;
}
table .text-center, table .text-center {
  text-align: center;
}
table .text-right, table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
</style>

</head>
<body>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Oblivious HTTP</td>
<td class="right">January 2021</td>
</tr></thead>
<tfoot><tr>
<td class="left">Thomson &amp; Wood</td>
<td class="center">Expires 26 July 2021</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">HTTPBIS</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-thomson-http-oblivious</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2021-01-22" class="published">22 January 2021</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2021-07-26">26 July 2021</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">M. Thomson</div>
<div class="org">Mozilla</div>
</div>
<div class="author">
      <div class="author-name">C.A. Wood</div>
<div class="org">Cloudflare</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Oblivious HTTP</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a system for the forwarding of encrypted HTTP messages.
This allows clients to make requests of servers without the server being able to
link requests to other requests from the same client.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-discussion-venues">
<a href="#name-discussion-venues" class="section-name selfRef">Discussion Venues</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">Discussion of this document takes place on the
  HTTP Working Group mailing list (http@ietf.org),
  which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/http/">https://mailarchive.ietf.org/arch/browse/http/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">Source for this draft and an issue tracker can be found at
  <span><a href="https://github.com/unicorn-wg/oblivious-http">https://github.com/unicorn-wg/oblivious-http</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 26 July 2021.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2021 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Simplified BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Simplified BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="xref">1</a>.  <a href="#name-introduction" class="xref">Introduction</a><a href="#section-toc.1-1.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="xref">2</a>.  <a href="#name-conventions-and-definitions" class="xref">Conventions and Definitions</a><a href="#section-toc.1-1.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1" class="keepWithNext"><a href="#section-3" class="xref">3</a>.  <a href="#name-overview" class="xref">Overview</a><a href="#section-toc.1-1.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="xref">4</a>.  <a href="#name-hpke-encapsulation" class="xref">HPKE Encapsulation</a><a href="#section-toc.1-1.4.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="xref">4.1</a>.  <a href="#name-hpke-encapsulation-of-reque" class="xref">HPKE Encapsulation of Requests</a><a href="#section-toc.1-1.4.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="xref">4.2</a>.  <a href="#name-hpke-encapsulation-of-respo" class="xref">HPKE Encapsulation of Responses</a><a href="#section-toc.1-1.4.2.2.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="xref">4.3</a>.  <a href="#name-padding" class="xref">Padding</a><a href="#section-toc.1-1.4.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="xref">5</a>.  <a href="#name-responsibility-of-roles" class="xref">Responsibility of Roles</a><a href="#section-toc.1-1.5.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="xref">5.1</a>.  <a href="#name-client" class="xref">Client</a><a href="#section-toc.1-1.5.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="xref">5.2</a>.  <a href="#name-proxy-responsibilities" class="xref">Proxy Responsibilities</a><a href="#section-toc.1-1.5.2.2.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.5.2.2.2.1">
                    <p id="section-toc.1-1.5.2.2.2.1.1"><a href="#section-5.2.1" class="xref">5.2.1</a>.  <a href="#name-denial-of-service" class="xref">Denial of Service</a><a href="#section-toc.1-1.5.2.2.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="ulEmpty compact toc" id="section-toc.1-1.5.2.2.2.2">
                    <p id="section-toc.1-1.5.2.2.2.2.1"><a href="#section-5.2.2" class="xref">5.2.2</a>.  <a href="#name-linkability-through-traffic" class="xref">Linkability Through Traffic Analysis</a><a href="#section-toc.1-1.5.2.2.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="xref">5.3</a>.  <a href="#name-server-responsibilities" class="xref">Server Responsibilities</a><a href="#section-toc.1-1.5.2.3.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="xref">6</a>.  <a href="#name-security-considerations" class="xref">Security Considerations</a><a href="#section-toc.1-1.6.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="xref">7</a>.  <a href="#name-iana-considerations" class="xref">IANA Considerations</a><a href="#section-toc.1-1.7.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="xref">8</a>.  <a href="#name-references" class="xref">References</a><a href="#section-toc.1-1.8.1" class="pilcrow">¶</a></p>
<ul class="ulEmpty compact toc">
<li class="ulEmpty compact toc" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="xref">8.1</a>.  <a href="#name-normative-references" class="xref">Normative References</a><a href="#section-toc.1-1.8.2.1.1" class="pilcrow">¶</a></p>
</li>
              <li class="ulEmpty compact toc" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="xref">8.2</a>.  <a href="#name-informative-references" class="xref">Informative References</a><a href="#section-toc.1-1.8.2.2.1" class="pilcrow">¶</a></p>
</li>
            </ul>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-appendix.a" class="xref"></a><a href="#name-acknowledgments" class="xref">Acknowledgments</a><a href="#section-toc.1-1.9.1" class="pilcrow">¶</a></p>
</li>
          <li class="ulEmpty compact toc" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-appendix.b" class="xref"></a><a href="#name-authors-addresses" class="xref">Authors' Addresses</a><a href="#section-toc.1-1.10.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The act of making a request using HTTP reveals information about the client
identity to a server. Though the content of requests might reveal information,
that is information under the control of the client. In comparison, the source
address on the connection reveals information that a client has only limited
control over.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">Even where an IP address is not directly attributed to an individual, the use
of an address over time can be used to correlate requests. Servers are able to
use this information to assemble profiles of client behavior, from which they
can make inferences about the people involved. The use of persistent
connections to make multiple requests improves performance, but provides
servers with additional certainty about the identity of clients in a similar
fashion.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">Use of an HTTP proxy can provide a degree of protection against servers
correlating requests. Systems like virtual private networks or the Tor network
<span>[<a href="#Dingledine2004" class="xref">Dingledine2004</a>]</span>, provide other options for clients.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">Though the overhead imposed by these methods varies, the cost for each request
is significant. Preventing request linkability requires that each request
use a completely new TLS connection to the server. At a minimum,
this requires an additional round trip to the server in addition to that
required by the request. In addition to having high latency, there are
significant secondary costs, both in terms of the number of additional bytes
exchanged and the CPU cost of cryptographic computations.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">This document describes a method of encapsulation for binary HTTP messages
<span>[<a href="#BINARY" class="xref">BINARY</a>]</span> using Hybrid Public Key Encryption (HPKE;
<span>[<a href="#HPKE" class="xref">HPKE</a>]</span>). This protects the content of both requests and
responses and enables a deployment architecture that can separate the identity
of a requester from the request.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">Though this scheme requires that servers and proxies explicitly support it,
this design represents a performance improvement over options that perform just
one request in each connection. With limited trust placed in the proxy (see
<a href="#trust" class="xref">Section 5</a>), clients are assured that requests are not uniquely attributed to
them or linked to other requests.<a href="#section-1-6" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
"MAY", and "OPTIONAL" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2-2">
        <dt id="section-2-2.1">
Encapsulated Request:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.2">
          <p id="section-2-2.2.1">An HTTP request that is encapsulated in an HPKE-encrypted message; see
<a href="#request" class="xref">Section 4.1</a>.<a href="#section-2-2.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.3">
Encapsulated Response:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.4">
          <p id="section-2-2.4.1">An HTTP response that is encapsulated in an HPKE-encrypted message; see
<a href="#response" class="xref">Section 4.2</a>.<a href="#section-2-2.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.5">
Oblivious Proxy Resource:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.6">
          <p id="section-2-2.6.1">An intermediary that forwards requests and responses between clients and a
single oblivious request resource.<a href="#section-2-2.6.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.7">
Oblivious Request Resource:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.8">
          <p id="section-2-2.8.1">A resource that can receive an encapsulated request, extract the contents of
that request, forward it to an oblivious target resource, receive a response,
encapsulate that response, then return that response.<a href="#section-2-2.8.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-2-2.9">
Oblivious Target Resource:  </dt>
        <dd style="margin-left: 1.5em" id="section-2-2.10">
          <p id="section-2-2.10.1">The resource that is the target of an encapsulated request.  This resource
logically handles only regular HTTP requests and responses and so might be
ignorant of the use of oblivious HTTP to reach it.<a href="#section-2-2.10.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-2-3">This draft includes pseudocode that uses the functions and conventions defined
in <span>[<a href="#HPKE" class="xref">HPKE</a>]</span>.<a href="#section-2-3" class="pilcrow">¶</a></p>
<p id="section-2-4">Encoding an integer to a sequence of bytes in network byte order is described
using the function <code>encode(n, v)</code>, where <code>n</code> is the number of bytes and <code>v</code> is
the integer value. The function <code>len()</code> returns the length of a sequence of
bytes.<a href="#section-2-4" class="pilcrow">¶</a></p>
<p id="section-2-5">Formats are described using notation from Section 1.3 of
<span>[<a href="#QUIC" class="xref">QUIC</a>]</span>.<a href="#section-2-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="overview">
<section id="section-3">
      <h2 id="name-overview">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
      </h2>
<p id="section-3-1">A client learns the following:<a href="#section-3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3-2.1">The identity of an oblivious request resource.  This might include some
information about oblivious target resources that the oblivious request
resource supports.<a href="#section-3-2.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-3-2.2">The details of an HPKE public key that the oblivious request resource accepts,
including an identifier for that key and the HPKE algorithms that are
used with that key.<a href="#section-3-2.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-3-2.3">The identity of an oblivious proxy resource that will forward encapsulated
requests and responses to the oblivious request resource.<a href="#section-3-2.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-3-3">This information allows the client to make a request of an oblivious target
resource without that resource having only a limited ability to correlate that
request with the client IP or other requests that the client might make to that
server.<a href="#section-3-3" class="pilcrow">¶</a></p>
<span id="name-overview-of-oblivious-http"></span><div id="fig-overview">
<figure id="figure-1">
        <div class="artwork art-text alignLeft" id="section-3-4.1">
<pre>
+---------+        +----------+        +----------+    +----------+
| Client  |        | Proxy    |        | Request  |    | Target   |
|         |        | Resource |        | Resource |    | Resource |
+---------+        +----------+        +----------+    +----------+
     |                  |                   |               |
     | Encapsulated     |                   |               |
     | Request          |                   |               |
     |-----------------&gt;| Encapsulated      |               |
     |                  | Request           |               |
     |                  |------------------&gt;| Request       |
     |                  |                   |--------------&gt;|
     |                  |                   |               |
     |                  |                   |      Response |
     |                  |      Encapsulated |&lt;--------------|
     |                  |          Response |               |
     |     Encapsulated |&lt;------------------|               |
     |         Response |                   |               |
     |&lt;-----------------|                   |               |
     |                  |                   |               |
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-overview-of-oblivious-http" class="selfRef">Overview of Oblivious HTTP</a>
        </figcaption></figure>
</div>
<p id="section-3-5">In order to make a request to an oblivious target resource, the following steps
occur, as shown in <a href="#fig-overview" class="xref">Figure 1</a>:<a href="#section-3-5" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-3-6">
<li id="section-3-6.1">The client constructs an HTTP request for an oblivious target resource.<a href="#section-3-6.1" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.2">The client encodes the HTTP request in a binary HTTP message and then
encapsulates that message using HPKE and the process from <a href="#request" class="xref">Section 4.1</a>.<a href="#section-3-6.2" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.3">The client sends a POST request to the oblivious proxy resource with the
encapsulated request as the content of that message.<a href="#section-3-6.3" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.4">The oblivious proxy resource forwards this request to the oblivious request
resource.<a href="#section-3-6.4" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.5">The oblivious request resource receives this request and removes
the HPKE protection to obtain an HTTP request.<a href="#section-3-6.5" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.6">The oblivious request resource makes an HTTP request that includes the target
URI, method, fields, and content of the request it acquires.<a href="#section-3-6.6" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.7">The oblivious target resource answers this HTTP request with an HTTP
response.<a href="#section-3-6.7" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.8">The oblivious request resource encapsulates the HTTP response following the
process in <a href="#response" class="xref">Section 4.2</a> and sends this in response to the request from the
oblivious proxy resource.<a href="#section-3-6.8" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.9">The oblivious proxy resource forwards this response to the client.<a href="#section-3-6.9" class="pilcrow">¶</a>
</li>
        <li id="section-3-6.10">The client removes the encapsulation to obtain the response to the original
request.<a href="#section-3-6.10" class="pilcrow">¶</a>
</li>
      </ol>
</section>
</div>
<div id="hpke-encapsulation">
<section id="section-4">
      <h2 id="name-hpke-encapsulation">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-hpke-encapsulation" class="section-name selfRef">HPKE Encapsulation</a>
      </h2>
<p id="section-4-1">HTTP message encapsulation uses HPKE for request and response encryption.
An encapsulated HTTP message includes the following values:<a href="#section-4-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4-2">
<li id="section-4-2.1">A binary-encoded HTTP message; see <span>[<a href="#BINARY" class="xref">BINARY</a>]</span>.<a href="#section-4-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-4-2.2">Padding of arbitrary length which MUST contain all zeroes.<a href="#section-4-2.2" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-4-3">The encoding of an HTTP message is as follows:<a href="#section-4-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4-4">
<pre>
Plaintext Message {
  Message Length (i),
  Message (..),
  Padding Length (i),
  Padding (..),
}
</pre><a href="#section-4-4" class="pilcrow">¶</a>
</div>
<p id="section-4-5">An Encapsulated Request is comprised of a length-prefixed key identifier and a
HPKE-protected request message. HPKE protection includes an encapsulated KEM
shared secret (or <code>enc</code>), plus the AEAD-protected request message. An
Encapsulated Request is shown in <a href="#fig-enc-request" class="xref">Figure 2</a>. <a href="#request" class="xref">Section 4.1</a> describes the
process for constructing and processing an Encapsulated Request.<a href="#section-4-5" class="pilcrow">¶</a></p>
<span id="name-encapsulated-request"></span><div id="fig-enc-request">
<figure id="figure-2">
        <div class="artwork art-text alignLeft" id="section-4-6.1">
<pre>
Encapsulated Request {
  Key Identifier (8),
  Encapsulated KEM Shared Secret (..),
  AEAD-Protected Request (..),
}
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-encapsulated-request" class="selfRef">Encapsulated Request</a>
        </figcaption></figure>
</div>
<p id="section-4-7">Responses are bound to responses and so consist only of AEAD-protected content.
<a href="#response" class="xref">Section 4.2</a> describes the process for constructing and processing an
Encapsulated Response.<a href="#section-4-7" class="pilcrow">¶</a></p>
<span id="name-encapsulated-response"></span><div id="fig-enc-response">
<figure id="figure-3">
        <div class="artwork art-text alignLeft" id="section-4-8.1">
<pre>
Encapsulated Response {
  Nonce (Nk),
  AEAD-Protected Response (..),
}
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-encapsulated-response" class="selfRef">Encapsulated Response</a>
        </figcaption></figure>
</div>
<p id="section-4-9">The size of the Nonce field in an Encapsulated Response corresponds to the
size of an AEAD key for the corresponding HPKE ciphersuite.<a href="#section-4-9" class="pilcrow">¶</a></p>
<div id="request">
<section id="section-4.1">
        <h3 id="name-hpke-encapsulation-of-reque">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-hpke-encapsulation-of-reque" class="section-name selfRef">HPKE Encapsulation of Requests</a>
        </h3>
<p id="section-4.1-1">Clients encapsulate a request <code>request</code> using values from a key configuration:<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.1-2.1">the key identifier from the configuration, <code>keyID</code>,<a href="#section-4.1-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-2.2">the public key from the configuration, <code>pkR</code>, and<a href="#section-4.1-2.2" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-4.1-2.3">a selected combination of KDF, identified by <code>kdfID</code>, and AEAD, identified by
<code>aeadID</code>.<a href="#section-4.1-2.3" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-4.1-3">The client then constructs an encapsulated request, <code>enc_request</code>, as follows:<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.1-4">
<li id="section-4.1-4.1">Compute an HPKE context using <code>pkR</code>, yielding <code>context</code> and encapsulation
key <code>enc</code>.<a href="#section-4.1-4.1" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-4.2">Construct associated data, <code>aad</code>, by concatenating the values of <code>keyID</code>,
<code>kdfID</code>, and <code>aeadID</code>, as 8-, 16- and 16-bit integers respectively, each in
network byte order.<a href="#section-4.1-4.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-4.3">Encrypt (seal) <code>request</code> with <code>aad</code> as associated data using <code>context</code>,
yielding ciphertext <code>ct</code>.<a href="#section-4.1-4.3" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-4.4">Concatenate the three values of <code>aad</code>, <code>enc</code>, and <code>ct</code>, yielding an
Encapsulated Request <code>enc_request</code>.<a href="#section-4.1-4.4" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.1-5">Note that <code>enc</code> is of fixed-length, so there is no ambiguity in parsing this
structure.<a href="#section-4.1-5" class="pilcrow">¶</a></p>
<p id="section-4.1-6">In pseudocode, this procedure is as follows:<a href="#section-4.1-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1-7">
<pre>
enc, context = SetupBaseS(pkR, "request")
aad = concat(encode(1, keyID),
             encode(2, kdfID),
             encode(2, aeadID))
ct = context.Seal(aad, request)
enc_request = concat(aad, keyID, enc, ct)
</pre><a href="#section-4.1-7" class="pilcrow">¶</a>
</div>
<p id="section-4.1-8">Servers decrypt an Encapsulated Request by reversing this process. Given an
Encapsulated Request <code>enc_request</code>, a server:<a href="#section-4.1-8" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.1-9">
<li id="section-4.1-9.1">
            <p id="section-4.1-9.1.1">Parses <code>enc_request</code> into <code>keyID</code>, <code>kdfID</code>, <code>aeadID</code>, <code>enc</code>, and <code>ct</code>
(indicated using the function <code>parse()</code> in pseudocode). The server is then
able to find the HPKE private key, <code>skR</code>, corresponding to <code>keyID</code>.<a href="#section-4.1-9.1.1" class="pilcrow">¶</a></p>
<p id="section-4.1-9.1.2">
a. If <code>keyID</code> does not identify a key, the server returns an error.<a href="#section-4.1-9.1.2" class="pilcrow">¶</a></p>
<p id="section-4.1-9.1.3">
b. If <code>kdfID</code> and <code>aeadID</code> identify a combination of KDF and AEAD that the
   server is unwilling to use with <code>skR</code>, the server returns an error.<a href="#section-4.1-9.1.3" class="pilcrow">¶</a></p>
</li>
          <li id="section-4.1-9.2">Compute an HPKE context using <code>skR</code> and the encapsulated key <code>enc</code>,
yielding <code>context</code>.<a href="#section-4.1-9.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-9.3">Construct additional associated data, <code>aad</code>, from <code>keyID</code>, <code>kdfID</code>, and
<code>aeadID</code> or as the first five bytes of <code>enc_request</code>.<a href="#section-4.1-9.3" class="pilcrow">¶</a>
</li>
          <li id="section-4.1-9.4">Decrypt <code>ct</code> using <code>aad</code> as associated data, yielding <code>request</code> or an error
on failure. If decryption fails, the server returns an error.<a href="#section-4.1-9.4" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.1-10">In pseudocode, this procedure is as follows:<a href="#section-4.1-10" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.1-11">
<pre>
keyID, kdfID, aeadID, enc, ct = parse(enc_request)
aad = concat(encode(1, keyID),
             encode(2, kdfID),
             encode(2, aeadID))
context = SetupBaseR(enc, skR, "request")
request, error = context.Open(keyID, ct)
</pre><a href="#section-4.1-11" class="pilcrow">¶</a>
</div>
<p id="section-4.1-12">Servers MUST verify that the request padding consists of all zeroes before
processing the corresponding Message.<a href="#section-4.1-12" class="pilcrow">¶</a></p>
</section>
</div>
<div id="response">
<section id="section-4.2">
        <h3 id="name-hpke-encapsulation-of-respo">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-hpke-encapsulation-of-respo" class="section-name selfRef">HPKE Encapsulation of Responses</a>
        </h3>
<p id="section-4.2-1">Given an HPKE context <code>context</code>, a request message <code>request</code>, and a response
<code>response</code>, servers generate an Encapsulated Response <code>enc_response</code> as
follows:<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.2-2">
<li id="section-4.2-2.1">Export a secret <code>secret</code> from <code>context</code>, using the string "response" as a
label. The length of this secret is <code>Nk</code> - the length of an AEAD key
assocated with <code>context</code>.<a href="#section-4.2-2.1" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.2">Generate a random value of length <code>max(Nn, Nk)</code> bytes, called <code>response_nonce</code>.<a href="#section-4.2-2.2" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.3">Extract a pseudorandom key <code>prk</code> using the <code>Extract</code> function provided by
the KDF algorithm associated with <code>context</code>. The <code>ikm</code> input to this
function is <code>secret</code>; the <code>salt</code> input is the concatenation of <code>enc</code> (from
<code>enc_request</code>) and <code>response_nonce</code><a href="#section-4.2-2.3" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.4">Use the <code>Expand</code> function provided by the same KDF to extract an AEAD key
<code>key</code>, of length <code>Nk</code> - the length of the keys used by the AEAD associated
with <code>context</code>. Generating <code>key</code> uses a label of "key".<a href="#section-4.2-2.4" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.5">Use the same <code>Expand</code> function to extract a nonce <code>nonce</code> of length <code>Nn</code> -
the length of the nonce used by the AEAD. Generating <code>nonce</code> uses a label of
"nonce".<a href="#section-4.2-2.5" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.6">Encrypt <code>response</code>, passing the AEAD function Seal the values of <code>key</code>,
<code>nonce</code>, empty <code>aad</code>, and a <code>pt</code> input of <code>request</code>, which yields <code>ct</code>.<a href="#section-4.2-2.6" class="pilcrow">¶</a>
</li>
          <li id="section-4.2-2.7">Concatenate <code>response_nonce</code> and <code>ct</code>, yielding an Encapsulated Response
<code>enc_response</code>. Note that <code>response_nonce</code> is of fixed-length, so there is no
ambiguity in parsing either <code>response_nonce</code> or <code>ct</code>.<a href="#section-4.2-2.7" class="pilcrow">¶</a>
</li>
        </ol>
<p id="section-4.2-3">In pseudocode, this procedure is as follows:<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.2-4">
<pre>
secret = context.Export("response", Nk)
response_nonce = random(max(Nn, Nk))
salt = concat(enc, response_nonce)
prk = Extract(salt, secret)
aead_key = Expand(secret, "key", Nk)
aead_nonce = Expand(secret, "nonce", Nn)
enc_reponse = Seal(aead_key, aead_nonce, "", response)
</pre><a href="#section-4.2-4" class="pilcrow">¶</a>
</div>
<p id="section-4.2-5">Clients decrypt an Encapsulated Request by reversing this process. That is,
they first parse <code>enc_response</code> into <code>response_nonce</code> and <code>ct</code>. They then
follow the same process to derive values for <code>aead_key</code> and <code>aead_nonce</code>.<a href="#section-4.2-5" class="pilcrow">¶</a></p>
<p id="section-4.2-6">The client uses these values to decrypt <code>ct</code> using the Open function provided by
the AEAD. Decrypting might produce an error, as follows:<a href="#section-4.2-6" class="pilcrow">¶</a></p>
<div class="artwork art-text alignLeft" id="section-4.2-7">
<pre>
reponse, error = Open(aead_key, aead_nonce, "", ct)
</pre><a href="#section-4.2-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="padding">
<section id="section-4.3">
        <h3 id="name-padding">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-padding" class="section-name selfRef">Padding</a>
        </h3>
<p id="section-4.3-1">Plaintext Messages support arbitrary length padding. Clients and servers MAY pad HTTP messages
as needed to hide metadata leakage through ciphertext length.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="trust">
<section id="section-5">
      <h2 id="name-responsibility-of-roles">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-responsibility-of-roles" class="section-name selfRef">Responsibility of Roles</a>
      </h2>
<p id="section-5-1">In this design, a client wishes to make a request of a server that is
authoritative for the oblivious target resource. The client wishes to make this
request without linking that request with either:<a href="#section-5-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-5-2">
<li id="section-5-2.1">The identity at the network and transport layer of the client (that is, the
client IP address and TCP or UDP port number the client uses to create a
connection).<a href="#section-5-2.1" class="pilcrow">¶</a>
</li>
        <li id="section-5-2.2">Any other request the client might have made in the past or might make in
the future.<a href="#section-5-2.2" class="pilcrow">¶</a>
</li>
      </ol>
<p id="section-5-3">In order to ensure this, the client selects a proxy (that serves the oblivious
proxy resource) that it trusts will protect this information by forwarding the
encapsulated request and response without passing the server (that serves the
oblivious request resource).<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">In this section, a deployment where there are three entities is considered:<a href="#section-5-4" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-5.1">A client makes requests and receives responses<a href="#section-5-5.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-5.2">A proxy operates the oblivious proxy resource<a href="#section-5-5.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-5.3">A server operates both the oblivious request resource and the oblivious
target resource<a href="#section-5-5.3" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-5-6">To achieve the stated privacy goals, the oblivious proxy resource cannot be
operated by the same entity as the oblivious request resource. However,
colocation of the oblivious request resource and oblivious target resource
simplifies the interactions between those resources without affecting client
privacy.<a href="#section-5-6" class="pilcrow">¶</a></p>
<div id="client">
<section id="section-5.1">
        <h3 id="name-client">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-client" class="section-name selfRef">Client</a>
        </h3>
<p id="section-5.1-1">Clients have the fewest direct responsibilities, though clients do need to
ensure that they do not undermine the process.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.1-2">Clients cannot carry connection-level state between requests as they only
establish direct connections to the proxy responsible for the oblivious proxy
resource. However, clients need to ensure that they construct requests without
any information gained from previous requests. Otherwise, the server might be
able to use that information to link requests. Cookies <span>[<a href="#COOKIES" class="xref">COOKIES</a>]</span> are
the most obvious feature that MUST NOT be used by clients. However, clients
need to include all information learned from requests, which could include the
identity of resources.<a href="#section-5.1-2" class="pilcrow">¶</a></p>
<p id="section-5.1-3">Clients also need to ensure that they correctly generate a new HPKE context for
every request, using a good source of entropy (<span>[<a href="#RANDOM" class="xref">RANDOM</a>]</span>). Key reuse
not only risks linkability, but it could expose request and response contents
to the proxy.<a href="#section-5.1-3" class="pilcrow">¶</a></p>
<p id="section-5.1-4">Clients constructing the request that is to be encapsulated need to avoid
including identifying information. Similarly, the request that is sent to the
oblivious request resource, though this request can contain only minimal
information as it only needs to include a method and the oblivious request
resource URL.<a href="#section-5.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="proxy-responsibilities">
<section id="section-5.2">
        <h3 id="name-proxy-responsibilities">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-proxy-responsibilities" class="section-name selfRef">Proxy Responsibilities</a>
        </h3>
<p id="section-5.2-1">The proxy that serves the oblivious proxy resource has a very simple function
to perform. It forwards messages received at this resource to the oblivious
request resource, and forwards responses from the oblivious request resource
back to clients. The proxy MUST forward response status codes without
modification.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2-2">The proxy MUST NOT add information about the client identity when forwarding
requests. This includes the Via field, the Forwarded field
<span>[<a href="#FORWARDED" class="xref">FORWARDED</a>]</span>, and any similar information.<a href="#section-5.2-2" class="pilcrow">¶</a></p>
<div id="dos">
<section id="section-5.2.1">
          <h4 id="name-denial-of-service">
<a href="#section-5.2.1" class="section-number selfRef">5.2.1. </a><a href="#name-denial-of-service" class="section-name selfRef">Denial of Service</a>
          </h4>
<p id="section-5.2.1-1">As there are privacy benefits from having a large rate of requests forwarded by
the same proxy (see <a href="#ta" class="xref">Section 5.2.2</a>), servers that operate the oblivious request
resource might need an arrangement with proxies. This arrangement might be
necessary to prevent having the large volume of requests being classified as an
attack by the server.<a href="#section-5.2.1-1" class="pilcrow">¶</a></p>
<p id="section-5.2.1-2">If a server does accept a large volume of requests from a proxy, it needs to
trust that the proxy does not allow abusive levels of request volumes from
clients. That is, if a server allows requests from the proxy to be exempt from
rate limits, the server might want to ensure that the proxy applies similar
rate limiting when receiving requests from clients.<a href="#section-5.2.1-2" class="pilcrow">¶</a></p>
<p id="section-5.2.1-3">Servers that enter into an agreement with a proxy that enables a higher request
rate might choose to authenticate the proxy to enable the higher rate.<a href="#section-5.2.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="ta">
<section id="section-5.2.2">
          <h4 id="name-linkability-through-traffic">
<a href="#section-5.2.2" class="section-number selfRef">5.2.2. </a><a href="#name-linkability-through-traffic" class="section-name selfRef">Linkability Through Traffic Analysis</a>
          </h4>
<p id="section-5.2.2-1">As the time at which encapsulated request or response messages are sent can
reveal information to a network observer. Though messages exchanged between the
oblivious proxy resource and the oblivious request resource might be sent in a
single connection, traffic analysis could be used to match messages that are
forwarded by the proxy.<a href="#section-5.2.2-1" class="pilcrow">¶</a></p>
<p id="section-5.2.2-2">A proxy could, as part of its function, add delays in order to increase the
anonymity set into which each message is attributed. This could latency to the
overall time clients take to receive a response, which might not what some
clients want.<a href="#section-5.2.2-2" class="pilcrow">¶</a></p>
<p id="section-5.2.2-3">A proxy can use padding to reduce the effectiveness of traffic analysis.<a href="#section-5.2.2-3" class="pilcrow">¶</a></p>
<p id="section-5.2.2-4">A proxy that forwards large volumes of exchanges can provide better privacy by
providing larger sets of messages that need to be matched.<a href="#section-5.2.2-4" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="server-responsibilities">
<section id="section-5.3">
        <h3 id="name-server-responsibilities">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-server-responsibilities" class="section-name selfRef">Server Responsibilities</a>
        </h3>
<p id="section-5.3-1">A server that operates both oblivious request and oblivious target resources is
responsible for removing request encapsulation, generating a response the
encapsulated request, and encapsulating the response.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">Servers should account for traffic analysis based on response size or generation time.
Techniques such as padding or timing delays can help protect against such attacks;
see <a href="#ta" class="xref">Section 5.2.2</a>.<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<p id="section-5.3-3">If separate entities provide the oblivious request resource and oblivious
target resource, these entities might need an arrangement similar to that
between server and proxy for managing denial of service; see <a href="#dos" class="xref">Section 5.2.1</a>. It is
also necessary to provide confidentiality protection for the unprotected
requests and responses, plus protections for traffic analysis; see <a href="#ta" class="xref">Section 5.2.2</a>.<a href="#section-5.3-3" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-6">
      <h2 id="name-security-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-6-1">Words...<a href="#section-6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="iana-considerations">
<section id="section-7">
      <h2 id="name-iana-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<p id="section-7-1">TODO: Define a media type or types here.<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-8">
      <h2 id="name-references">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-references" class="section-name selfRef">References</a>
      </h2>
<section id="section-8.1">
        <h3 id="name-normative-references">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
        </h3>
<dl class="references">
<dt id="BINARY">[BINARY]</dt>
        <dd>
<span class="refAuthor">Thomson, M.</span>, <span class="refTitle">"Binary Representation of HTTP Messages"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-http-binary-message-latest</span>, <time datetime="2021-01-22" class="refDate">22 January 2021</time>, <span>&lt;<a href="https://tools.ietf.org/html/draft-ietf-http-binary-message-latest">https://tools.ietf.org/html/draft-ietf-http-binary-message-latest</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="HPKE">[HPKE]</dt>
        <dd>
<span class="refAuthor">Barnes, R.</span><span class="refAuthor">, Bhargavan, K.</span><span class="refAuthor">, Lipp, B.</span><span class="refAuthor">, and C. Wood</span>, <span class="refTitle">"Hybrid Public Key Encryption"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-irtf-cfrg-hpke-07</span>, <time datetime="2020-12-16" class="refDate">16 December 2020</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-07.txt">http://www.ietf.org/internet-drafts/draft-irtf-cfrg-hpke-07.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="QUIC">[QUIC]</dt>
        <dd>
<span class="refAuthor">Iyengar, J.</span><span class="refAuthor"> and M. Thomson</span>, <span class="refTitle">"QUIC: A UDP-Based Multiplexed and Secure Transport"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-quic-transport-34</span>, <time datetime="2021-01-14" class="refDate">14 January 2021</time>, <span>&lt;<a href="http://www.ietf.org/internet-drafts/draft-ietf-quic-transport-34.txt">http://www.ietf.org/internet-drafts/draft-ietf-quic-transport-34.txt</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
      <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-8.2">
        <h3 id="name-informative-references">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
        </h3>
<dl class="references">
<dt id="COOKIES">[COOKIES]</dt>
        <dd>
<span class="refAuthor">Barth, A.</span>, <span class="refTitle">"HTTP State Management Mechanism"</span>, <span class="seriesInfo">RFC 6265</span>, <span class="seriesInfo">DOI 10.17487/RFC6265</span>, <time datetime="2011-04" class="refDate">April 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6265">https://www.rfc-editor.org/info/rfc6265</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="Dingledine2004">[Dingledine2004]</dt>
        <dd>
<span class="refAuthor">Dingledine, R.</span><span class="refAuthor">, Mathewson, N.</span><span class="refAuthor">, and P. Syverson</span>, <span class="refTitle">"Tor: The Second-Generation Onion Router"</span>, <time datetime="2004-08" class="refDate">August 2004</time>, <span>&lt;<a href="https://svn.torproject.org/svn/projects/design-paper/tor-design.html">https://svn.torproject.org/svn/projects/design-paper/tor-design.html</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="FORWARDED">[FORWARDED]</dt>
        <dd>
<span class="refAuthor">Petersson, A.</span><span class="refAuthor"> and M. Nilsson</span>, <span class="refTitle">"Forwarded HTTP Extension"</span>, <span class="seriesInfo">RFC 7239</span>, <span class="seriesInfo">DOI 10.17487/RFC7239</span>, <time datetime="2014-06" class="refDate">June 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7239">https://www.rfc-editor.org/info/rfc7239</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RANDOM">[RANDOM]</dt>
      <dd>
<span class="refAuthor">Eastlake 3rd, D.</span><span class="refAuthor">, Schiller, J.</span><span class="refAuthor">, and S. Crocker</span>, <span class="refTitle">"Randomness Requirements for Security"</span>, <span class="seriesInfo">BCP 106</span>, <span class="seriesInfo">RFC 4086</span>, <span class="seriesInfo">DOI 10.17487/RFC4086</span>, <time datetime="2005-06" class="refDate">June 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4086">https://www.rfc-editor.org/info/rfc4086</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
</section>
<div id="acknowledgments">
<section id="section-appendix.a">
      <h2 id="name-acknowledgments">
<a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="section-appendix.a-1">TODO: credit where credit is due.<a href="#section-appendix.a-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="section-appendix.b">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Martin Thomson</span></div>
<div dir="auto" class="left"><span class="org">Mozilla</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:mt@lowentropy.net" class="email">mt@lowentropy.net</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christopher A. Wood</span></div>
<div dir="auto" class="left"><span class="org">Cloudflare</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:caw@heapingbits.net" class="email">caw@heapingbits.net</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
